### OpenAI API

[OpenAI Platform](https://platform.openai.com/docs/api-reference/chat/create)

### Natural Language API

[Natural Language API 기초  |  Google Cloud](https://cloud.google.com/natural-language/docs/basics?hl=ko)

**1. 환경 설정 및 라이브러리 임포트**

- 필요한 라이브러리를 임포트하고, Google Cloud Natural Language API와 OpenAI에 필요한 환경 변수 설정

```python
import openai
from google.cloud import language_v1
import os
```

**2. `refine_tone_with_openai` 함수**

- **`refine_tone_with_openai`** :  주어진 텍스트의 어조를 개선하고, 감정 점수를 분석하여 부정적인 텍스트를 감지하는 주요 함수
- Google Cloud Natural Language API를 사용하여 주어진 텍스트의 감정 점수를 분석
- 감정 점수가 일정한 부정적인 임계값보다 낮으면 텍스트를 부정적으로 간주
- OpenAI를 사용하여 어조 개선

**3. Google Cloud Natural Language API를 통한 감정 분석**

- **`language_v1.LanguageServiceClient`**를 사용하여 주어진 텍스트의 감정을 분석
    
    ```python
    # Google Cloud Natural Language API를 사용하여 감정 점수 판단
        document = language_v1.Document(content=text_to_refine, type_=language_v1.Document.Type.PLAIN_TEXT)
        sentiment = client.analyze_sentiment(request={"document": document}).document_sentiment
    ```
    
- 감정 점수가 부정적인지 여부를 판단하기 위해 설정된 임계값을 사용
    
    ```python
    # 감정 점수를 기준으로 텍스트가 부정적인지 판단합니다.
        negative_threshold = -0.2
        is_negative = sentiment.score < negative_threshold
    ```
    

**4. 텍스트 개선 요청 및 OpenAI API 호출**

- 감정이 부정적으로 감지되면, OpenAI에게 주어진 텍스트를 존댓말로 변환하고 욕설을 제거하여 어조를 개선하도록 요청

```python
if is_negative:
        # 만약 텍스트가 부정적이라면, openai에게 어조를 개선하도록 요청합니다.
        prompt = f'''
        주어진 문장을 존댓말과 욕설을 제거하고, 순화한 문장으로 바꿔주세요.

        원래 말투: "{text_to_refine}"
        순화된 말투:'''
```

- OpenAI API를 호출하여 어조 개선 수행

```python
# OpenAI API를 호출하여 어조를 개선합니다.
        response = openai.ChatCompletion.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": "넌 챗봇이야."},
                {"role": "user", "content": prompt}
            ]
        )

        refined_text = response.choices[0].message.content.strip()
```

**5. 결과 반환**

- 개선된 텍스트와 감정 점수를 반환

```python
# 감정 점수와 함께 반환합니다.
        return refined_text, sentiment.score
```

**6. 사용 예제 및 결과 확인**

- Google Cloud 서비스 계정 키와 OpenAI API 키를 설정하고, 주어진 텍스트를 **`refine_tone_with_openai`** 함수에 전달하여 어조 개선

```
text_to_refine = "어이가 없네"
refined_text, sentiment_score = refine_tone_with_openai(text_to_refine, google_cloud_key, openai_api_key)
```

- 원본 텍스트, 개선된 텍스트, 및 감정 점수를 출력하여 결과 확인

```
print("Original Text:", text_to_refine)
print("Refined Text:", refined_text)
print("Sentiment Score:", sentiment_score)
```
